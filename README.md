# Keybase notification sending resource

A [Concourse CI](https://concourse-ci.org/) resource for sending notifications to [Keybase](https://keybase.io/) chats.

This resource uses the Keybase CLI to send messages to Keybase users, teams, and channels. It is designed to be stateless, with no secrets stored in the image. Authentication is done at runtime using the provided username and paperkey.

The image includes the Keybase CLI and a utility script to generate a paperkey for your Keybase account, which can be useful for setting up bot accounts.

## Features

- Send messages to Keybase users, teams, and channels
- Support for message formatting (plain text, markdown)
- Support for silent notifications
- Stateless design with no secrets stored in the image
- Includes the Keybase CLI for full Keybase functionality
- Utility script for generating paperkeys

## Resource Type Configuration

```yaml
resource_types:
- name: keybase-chat
  type: docker-image
  source:
    repository: my-registry/keybase-resource
    tag: latest
```

## Source Configuration

* `username`: *Required.* The Keybase username to authenticate with.
* `paperkey`: *Required.* The paper key for authentication. You can generate a paper key with `keybase paperkey`.
* `team`: *Optional.* The default team to send messages to. If not specified, messages will be sent to the user specified in the `channel` parameter.
* `default_channel`: *Optional.* The default channel to send messages to. If not specified and no channel is provided in the params, messages will be sent to the user specified by the `username` parameter.
* `disable`: *Optional.* Set to `true` to skip all messaging. Convenient for temporarily disabling notifications without editing your pipelines.

Example:

```yaml
resources:
- name: keybase-alerts
  type: keybase-chat
  source:
    username: ((keybase-username))
    paperkey: ((keybase-paperkey))
    team: your_team_name
    default_channel: alerts
```

## Behavior

### `check` Step: No operation

Checking for new versions always returns the last timestamp-based dummy version, created when the last `put` step was executed on this resource.

### `in` Step: No operation

Getting a new version of this resource does nothing else that always returning the last timestamp-based dummy version, created when the last `put` step was executed on this resource.

### `put` Step: Sends a message to Keybase

Send a message to Keybase, with the configured parameters.

#### Parameters

You must specify one or more of the following:

* `text`: Static text of the message to send.
* `text_file`: File that contains the message to send. This allows the message to be generated by a previous task step in the Concourse job.

If you omit the `text` parameter, the content of the file specified in the `text_file` parameter will be used verbatim. Alternatively, you can include the environment variable `$TEXT_FILE_CONTENT` in the `text` string to include the content of the file with other static text and interpolated variables.

Optional:

* `channel`: *Optional.* Override channel to send message to. If not specified, the `default_channel` from the source configuration will be used.
* `team`: *Optional.* Override team to send message to. If not specified, the `team` from the source configuration will be used.
* `silent`: *Optional.* Do not print command output (avoids leaking paperkey). Defaults to `false`.

#### Metadata

Various metadata is available in the form of environment variables. Any environment variables present in the parameters will be automatically evaluated; this enables dynamic parameter content.

The following pipeline config snippet demonstrates how to incorporate the metadata:

```yaml
jobs:
- name: some-job
  plan:
  - put: keybase-alert
    params:
      text: |
        The build had a result. Check it out at:
        http://my.concourse.url/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME
        or at:
        http://my.concourse.url/builds/$BUILD_ID
```

See the [official documentation](https://concourse-ci.org/implementing-resource-types.html#resource-metadata) for a complete list of available metadata.

## Examples

```yaml
# Simple example
- put: keybase-alert
  params:
    text: Build succeeded!

# Using a file for the message content
- put: keybase-alert
  params:
    text_file: build-output/message.txt

# Combining static text with file content
- put: keybase-alert
  params:
    text_file: build-output/message.txt
    text: |
      Build $BUILD_NAME completed!
      Details:
      $TEXT_FILE_CONTENT

# Sending to a specific channel
- put: keybase-alert
  params:
    text: Important alert!
    channel: urgent-alerts
```

## Generating a Paperkey

The Docker image includes a utility script to generate a paperkey for your Keybase account. This is useful for creating paperkeys for bot accounts that will be used with this resource.

To generate a paperkey:

```bash
# Pull the image
docker pull my-registry/keybase-resource:latest

# Run the generate-paperkey.sh script
docker run --rm -it my-registry/keybase-resource:latest /usr/local/bin/generate-paperkey.sh <username> <password>
```

Replace `<username>` with your Keybase username and `<password>` with your Keybase password. The script will:

1. Start the Keybase service
2. Log in to your Keybase account
3. Generate a new paperkey
4. Display the paperkey in the terminal

Save this paperkey in a secure location, as it provides full access to your Keybase account. You can use this paperkey in your Concourse pipeline configuration.

## Testing the Resource

The repository includes a test script to verify that the resource is working correctly. The script sends a test message to a specified team or user.

```bash
# Run the test script
./test/docker-test.sh <username> <paperkey> <recipient> [channel]
```

Replace:
- `<username>` with your Keybase username
- `<paperkey>` with your Keybase paperkey
- `<recipient>` with either:
  - A team name (when sending to a team channel)
  - A username (when sending a direct message)
- `[channel]` (optional) with the channel name (only needed when sending to a team)

The script will:
1. Create a temporary test message
2. Send the message to the specified team/channel or user
3. Report the results
